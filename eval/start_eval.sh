#!/bin/bash
#TO BE DONE

# Global variables for arguments
WEB_MODE=false
INTRUSIVE_EVAL=true
DATASET_PATH='none'
META_FILE=''
SAVE_PATH='result.json'

# Prints usage
usage(){
    echo "./start_eval ARGUMENTS"
    echo "  Unique arguments aren't affected by others, if started in web_mode other arguments are taken into consideration."
    echo "  Instead, starts a server at localhost with GUI, where other parameters can be specified."
    echo "ARGUMENTS:"
    echo "      -wb | --web_mode true/false [optional, unique]"
    echo "          Whether to start evaluation as command line application or to enable UI in browser"   
    echo "      -ie | --intrusive_eval true/false [optional]"
    echo "          Whether to use both intrusive and non-intrusive evaluation"
    echo "          For intrusive evaluation reference samples are needed!!"
    echo "      -dp | --dataset_path path/to/your/dataset [optional]"
    echo "          Specifies dataset path, required if meta file contains only relative paths!"
    echo "      -mf | --meta_file path/to/your/meta/file [required]"
    echo "          Path to meta file" 
    echo "      -sp | --save_path path/to/result.json [optional]"
    echo "          Specifies path to the result file, default is result.json"
    echo ""
    echo "Examples:"
    echo "      ./start_eval.sh --web_mode true"
    echo "          Starts evaluation with GUI at localhost."
    echo "      ./start_eval.sh --dataset_path /path/to/dataset --meta_file /path/to/meta --save_path this.json"
    echo "          Starts evaluation for dataset at path /path/to/dataset with meta file at /path/to/meta"
    echo "          and saves results to this.json"
}

# Prints help
help(){
    echo ""
    echo "This program was designed as a Bachelor's thesis project."
    echo "Created by: Roman Machala"
    echo "Main idea for this project is to take a set of audios generated by any TTS system and evaluate"
    echo "them using some of objective metrics (PESQ, STOI, ESTOI, MCD) and a MOS predictor"
    echo "Appliation offers either a simple command line interface with simple logging or a GUI using uvicorn"
    echo ""
    usage

}

# Prints current set of arguments
current_setup(){
    echo "Starting evaluation for this setup:"
    echo "  WEB_MODE: $1"
    echo "  INTRUSIVE_EVAL: $2"
    echo "  META_FILE: $3"
    echo "  SAVE_PATH: $4"
    if [[ ! "$DATASET_PATH" = "none" ]]; then
        echo "  DATASET_PATH: $5"
    fi
}

#parses arguments
while [[ $# -gt 0 ]]; do
    case $1 in 
        -wm|--web_mode)
            WEB_MODE=$2
            shift
            shift
            ;;
        -ie|intrusive_eval)
            INTRUSIVE_EVAL=$2
            shift
            shift
            ;;
        -dp|--dataset_path)
            DATASET_PATH=$2
            shift
            shift
            ;;
        -mf|--meta_file)
            META_FILE=$2
            shift
            shift
            ;;
        -sp|--save_path)
            SAVE_PATH=$2
            shift
            shift
            ;;
        -h|--help)
            help
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done


if [[ "$WEB_MODE" = true ]]; then
    echo "Starting server at localhost"
    echo $(uvicorn audioEval:app --reload)
else
    if [[ -z $META_FILE ]]; then
        echo "No meta file was specified!"
        usage
        exit 1
    fi
    current_setup "$WEB_MODE" "$INTRUSIVE_EVAL" "$META_FILE" "$SAVE_PATH" "$DATASET_PATH"
    python3 audioEval.py "--meta_file $META_FILE --dataset_path $DATASET_PATH --save_path $SAVE_PATH --intrusive_eval $INTRUSIVE_EVAL"
fi


exit 0